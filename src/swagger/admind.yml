openapi: 3.0.0
info:
  title: Documentación de la API REST - Módulo de Administración
  description: Detalle de los puntos de acceso protegidos para la administración del sistema (requiere rol ADMIN).
  version: 1.0.0

# Definición de los servidores donde se encuentra la API
servers:
  - url: /api
    description: Servidor de la API

# --------------------------
# Definición de las RUTAS (Endpoints)
# --------------------------
paths:
  /socket/admin/update-inventory-master:
    get:
      tags:
        - Administración - Herramientas
      summary: Dispara la actualización del inventario maestro desde Google Sheet
      description: Dispara una actualización del inventario maestro desde Google Sheet y notifica a todos los clientes web conectados a través de WebSockets. **Solo accesible por administradores (ADMIN).**
      security:
        - BearerAuth: [] # Requiere el esquema de seguridad BearerAuth definido en components
      responses:
        '200':
          description: Inventario maestro actualizado.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageOnly'
              example:
                message: Inventario maestro actualizado.
        '401':
          description: Falla de Autenticación por Token.
          content:
            application/json:
              examples: # Muestra los posibles mensajes de error 401
                token_ausente:
                  $ref: '#/components/responses/UnauthorizedTokenAbsence/content/application/json/example'
                token_invalido_payload:
                  $ref: '#/components/responses/UnauthorizedInvalidPayload/content/application/json/example'
                usuario_no_encontrado:
                  $ref: '#/components/responses/UnauthorizedUserNotFound/content/application/json/example'
        '403':
          description: Acceso Denegado por Rol o Token Expirado/Inválido.
          content:
            application/json:
              examples: # Muestra los posibles mensajes de error 403
                no_admin:
                  $ref: '#/components/responses/ForbiddenAdminRole/content/application/json/example'
                token_expirado:
                  $ref: '#/components/responses/ForbiddenTokenExpired/content/application/json/example'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/users:
    get:
      tags:
        - Administración - Usuarios
      summary: Obtiene la lista de todos los usuarios
      description: Obtiene una lista de todos los usuarios registrados. **Requiere rol ADMIN.**
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Retorna un array con todos los usuarios.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserObject'
              example:
                - id: 1
                  username: admin_user
                  role: ADMIN
                - id: 2
                  username: test_user
                  role: USER
        '403':
          $ref: '#/components/responses/ForbiddenAdminRole'
        '404':
          description: No se encontraron usuarios en la base de datos.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: No se encontraron usuarios.
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      tags:
        - Administración - Usuarios
      summary: Registra un nuevo usuario en el sistema
      description: Registra un nuevo usuario en el sistema. **Requiere rol ADMIN.**
      security:
        - BearerAuth: []
      requestBody:
        description: Datos para la creación del nuevo usuario.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewUserPayload'
            example:
              username: nuevo_usuario
              password: una_contraseña_segura
              role: USER
      responses:
        '201':
          description: Usuario registrado con éxito.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageOnly'
              example:
                message: Nuevo usuario registrado con éxito.
        '400':
          description: Datos de entrada inválidos o role incorrecto.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              examples:
                missing_fields:
                  value:
                    message: Username, password y role son requeridos.
                invalid_role:
                  value:
                    message: El rol debe ser ADMIN o USER.
        '403':
          $ref: '#/components/responses/ForbiddenAdminRole'
        '409':
          description: El username ya está en uso.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: El nombre de usuario ya existe.
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/users/{id}:
    parameters:
      - name: id
        in: path
        description: ID del usuario a buscar, actualizar o eliminar.
        required: true
        schema:
          type: integer
          format: int64
    get:
      summary: Obtiene los detalles de un usuario específico
      tags:
        - Administración - Usuarios
      description: Obtiene los detalles de un usuario específico mediante su ID. **Requiere rol ADMIN.**
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Retorna el objeto del usuario.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserObject'
              example:
                id: 1
                username: admin_user
                role: ADMIN
        '400':
          description: El ID de usuario no es válido.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: El ID debe ser un número.
        '403':
          $ref: '#/components/responses/ForbiddenAdminRole'
        '404':
          description: El ID de usuario no existe en la base de datos.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: Usuario no encontrado
        '500':
          $ref: '#/components/responses/InternalServerError'
    patch:
      summary: Actualiza el nombre de usuario o el rol
      tags:
        - Administración - Usuarios
      description: Actualiza los datos de un usuario específico (`username` o `role`). **Requiere rol ADMIN.**
      security:
        - BearerAuth: []
      requestBody:
        description: Campos a actualizar (`username` o `role`).
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserPayload'
            example:
              role: ADMIN
      responses:
        '204':
          description: Usuario actualizado con éxito (No Content).
        '400':
          description: Errores en el ID, body vacío, password en body o rol incorrecto.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              examples:
                invalid_id:
                  value:
                    message: El ID debe ser un número.
                empty_body:
                  value:
                    message: No se proporcionaron datos para actualizar.
                password_found:
                  value:
                    message: Para cambiar la contraseña, utiliza el endpoint dedicado.
                invalid_role:
                  value:
                    message: El rol debe ser ADMIN o USER.
        '403':
          $ref: '#/components/responses/ForbiddenAdminRole'
        '404':
          description: No se encontró un usuario con ese ID.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: Usuario no encontrado
        '409':
          description: El username ya está en uso.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: El nombre de usuario ya existe.
        '500':
          $ref: '#/components/responses/InternalServerError'
    put:
      summary: Actualiza el password del usuario
      tags:
        - Administración - Usuarios
      description: Actualiza la contraseña de un usuario específico. **Requiere rol ADMIN.**
      security:
        - BearerAuth: []
      requestBody:
        description: Contraseña anterior (opcional) y nueva contraseña (requerida).
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePasswordPayload'
            example:
              newPassword: new_password
      responses:
        '204':
          description: Contraseña actualizada con éxito (No Content).
        '400':
          description: Errores en el ID o body incompleto.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              examples:
                invalid_id:
                  value:
                    message: El ID debe ser un número.
                incomplete_body:
                  value:
                    message: Se requieren la contraseña nueva.
        '401':
          description: La contraseña actual es incorrecta.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: La contraseña actual es incorrecta.
        '403':
          $ref: '#/components/responses/ForbiddenAdminRole'
        '404':
          description: No se encontró un usuario con ese ID.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: Usuario no encontrado
        '409':
          description: La nueva contraseña no puede ser igual a la anterior.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: La nueva contraseña no puede ser igual a la anterior..
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      summary: Elimina un usuario del sistema
      tags:
        - Administración - Usuarios
      description: Elimina un usuario del sistema mediante su ID. **Requiere rol ADMIN.**
      security:
        - BearerAuth: []
      responses:
        '204':
          description: Usuario eliminado con éxito (No Content).
        '400':
          description: El ID de usuario no es válido.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: El ID debe ser un número.
        '403':
          $ref: '#/components/responses/ForbiddenAdminRole'
        '404':
          description: No se encontró un usuario con ese ID.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'
              example:
                message: Usuario no encontrado
        '500':
          $ref: '#/components/responses/InternalServerError'

# --------------------------
# Definición de COMPONENTES Reusables
# --------------------------
components:
  # Esquema de Seguridad (para el accessToken)
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Proporcionar el accessToken obtenido en el login en el formato `Bearer <token>`.

  # Respuestas Estándar del Middleware de Autenticación/Autorización
  responses:
    UnauthorizedTokenAbsence:
      description: **Token Ausente/Formato**. No se encontró el encabezado `Authorization: Bearer <token>`.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorMessage'
          example:
            message: Token de acceso ausente o con formato incorrecto.
    UnauthorizedInvalidPayload:
      description: **Payload Inválido**. El contenido del token no tiene la estructura esperada.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorMessage'
          example:
            message: La estructura del token no es válida.
    UnauthorizedUserNotFound:
      description: **Usuario No Encontrado**. El ID del usuario en el token no corresponde a ningún registro activo en la DB.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorMessage'
          example:
            message: Usuario no encontrado.
    ForbiddenTokenExpired:
      description: **Token Expirado/Inválido**. El JWT falló la verificación de la firma o ha expirado.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorMessage'
          example:
            message: Token de acceso inválido o expirado.
    ForbiddenAdminRole:
      description: **Acceso Denegado por Rol**. El usuario no tiene rol de `ADMIN`.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorMessage'
          example:
            message: Acceso denegado: solo para administradores.
    InternalServerError:
      description: Ocurrió un error inesperado en el servidor.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorMessage'
          example:
            message: Error interno del servidor.

  # Esquemas de Datos (Schemas)
  schemas:
    # Esquema genérico para mensajes de éxito o error simples
    MessageOnly:
      type: object
      properties:
        message:
          type: string
          description: Mensaje de confirmación o estado.

    ErrorMessage:
      type: object
      properties:
        message:
          type: string
          description: Mensaje de error detallado.
          
    UserRole:
      type: string
      enum: [ADMIN, USER]
      description: Rol del usuario en el sistema.

    UserObject:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: ID único del usuario.
        username:
          type: string
          description: Nombre de usuario único.
        role:
          $ref: '#/components/schemas/UserRole'
      required:
        - id
        - username
        - role

    NewUserPayload:
      type: object
      properties:
        username:
          type: string
        password:
          type: string
          format: password
        role:
          $ref: '#/components/schemas/UserRole'
      required:
        - username
        - password
        - role

    UpdateUserPayload:
      type: object
      description: Campos opcionales para actualizar el usuario. No puede contener el campo 'password'.
      properties:
        username:
          type: string
          description: Nuevo nombre de usuario (opcional).
        role:
          $ref: '#/components/schemas/UserRole'
          description: Nuevo rol del usuario (opcional).
      # No tiene campos requeridos, pero en la práctica se debe enviar al menos uno.
      
    UpdatePasswordPayload:
      type: object
      description: Payload para actualizar la contraseña de un usuario.
      properties:
        oldPassword:
          type: string
          format: password
          description: Contraseña actual del usuario (opcional según el uso del endpoint).
        newPassword:
          type: string
          format: password
          description: La nueva contraseña.
      required:
        - newPassword
